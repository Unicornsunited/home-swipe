angular.module('houses.data', []);
angular.module('houses.dating', []);
angular.module('house-dating', ['ui.router', 'houses.data']);
(() => {
    angular.module('houses.dating').controller('datingCtrl', data => {
        console.log(data);
    });
})();
(() => {
    angular.module('houses.data').factory('zoopla', function ($http, $q) {
        function getZoopla(_url, _data) {
            var data = {
                api_key: "gndny3sqrvsgx483wpamyqe4",
                callback: "JSON_CALLBACK"
            },
                url = "/api/";

            angular.extend(data, _data);

            url = url + _url + ".json";

            var def = $q.defer();

            $http({
                'url': url,
                'method': 'GET',
                'params': data
            }).success(function (data) {
                def.resolve({
                    'status': 'success',
                    'data': data
                });
            });

            return def.promise;
        }

        function getListing(_data) {
            return getZoopla("property_listings", {
                postcode: 'sw4',
                area: 'London',
                listing_status: 'rent',
                minimum_price: 50,
                maximum_price: 500,
                order_by: 'age',
                page_size: 60
            });
        }

        function getHouse(id) {
            return getZoopla("property_listings", {
                listing_id: id
            });
        }

        return {
            getListing: getListing,
            getHouse: getHouse
        };
    });
})();

(() => {
    angular.module('house-dating').run(run).config(config);

    function run($rootScope, $state, $document) {
        $rootScope.$state = $state;
        $rootScope.apiUrl = {
            base: "/api",
            user: "/user"
        };

        $document.on('click', function () {
            $rootScope.$broadcast('bodyClick');
        });
    }

    function config($stateProvider, $urlRouterProvider) {
        $urlRouterProvider.otherwise("/");

        $stateProvider.state('base', {
            abstract: true,
            views: {
                top: {
                    templateUrl: "components/top/top.html"
                }
            }
        }). // controller: "topCtrl"
        state('base.dating', {
            url: "/",
            resolve: {
                data: zoopla => {
                    return zoopla.getListing();
                }
            },
            views: {
                mainContent: {
                    templateUrl: "components/dating/dating.html",
                    controller: "datingCtrl"
                }
            }
        });
    };
})();
